include "root" {
  path = find_in_parent_folders("root.hcl")
  expose  = true
}

terraform {
  source = "../../../modules/cluster-argocd"

  before_hook "set_dummy_context" {
    commands = ["apply", "plan"]

    execute = [
      "bash", "-c",
      <<-EOT
        kubectl config set-context argo-ctx --user=argo
      EOT
    ]
  }

}


dependencies {
  paths = ["../gitops-layer"]
}


dependency "stg_cluster" {
 config_path = "../../stg/cluster"
 mock_outputs = {
    kube_host = "https://my-aks-cluster-12345678.hcp.uksouth.azmk8s.io:443"
    cluster_ca_certificate = "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURRakNDQWZnZ0F3SUJBZ0lVSWJvOXh1ekVXTzBBRWd5QjI0RUY4ZmFzSHdZd0RRWUpLb1pJaHZjTkFRRUwKQlFBd2N6RUxNQWtHQTFVRUJoTUNWVk14RHpBTkJna3Foa2lHOXcwQkNRRVdLQ1VnQ1FZRFZRUUdFd0pWVXpFRApNQWtHQTFVRUF3d0hhR1Z5WlhKaGRHOXlNQjRYRFRFNU1ETXdPREUxTXpJd05Gb1hEVEk1TURNeU5ERTFNekl3Ck5Gb3dVekVMTUFrR0ExVUVDaE1DVlZNeER6QU5CZ2txaGtpRzl3MEJDUUVXQmdVd0lGQWRCZ05WSFE0RUZnUVUKSm5BTm5oM1ZDUERvU3p5bDBFdzFkTkptWGkrV0F3SHdZRFZSMGpCQmd3Rm9BVUpuQU5uaDNWQ1BEb1N6eWwwRQp3MWROTm1YaStXQXdId1lEVlIwakJCZ3dGb0FVSm5BTm5oM1ZDUERvU3p5bDBFdzFkTkptWGkrV0F3SkJnWUEwCkJBUURBZ05JQURCRkFpQWZCZ05WSFNNRUdEQVdnQlVjbDBlWkRuNlFVa3hnSlRkM0Frd0NnWUlLb1pJemowRUEKQkFBT0JRS0FNSGlMZVFsMXFFcGpMRVBkQlAxZDNqYUpBaTRJSmpZUG5jU3JYbXRaQkNPM3V0R1B2aFB3K0dRQQp0czF3QjFTVkhSaXdiN3BNNEZWMFFqMUh3QXZnZGZ2N2ZHVlhZMHlDRnByVTFmUExRT2NoRXcvNWxyZXNQUUVECkFBd0NnWUlLb1pJemowRUF3SURTQUF3UlFJaEFtNFVZMGxyZmFiY0lvZytCWjM4amV6blZTRUVZb1dPUVhTdGgKYU1NZ01Dd0dBMVVkSlFRTU1Bb0dDQ3NHQVFVRkJ3TUJNR1V4R1RBWEJnTlZCQW9UQURCRU1Rc3dDUVlEVlFRRwpCUUJBUVVGQkFNTUNnWUlLb1pJemowRUF3SURTQUF3UlFJZ01ERUxNQWtHQTFVRUJ4TU1TV2x2YkdSbGNtbGgKWTJGc0xYTnZibXh2Y0d4bExtTnZiUzh4RURBT0JnTlZIUThCQWY4RUJBTUNCNEF3Z2dJaU1BMEdDU3FHU0liMwpDQ0FHUUFJaEFtNFVZMGxyZmFiY0lvZytCWjM4amV6blZTRUVZb1dPUVhTdGhhTU1nTTNFakFBTUJnTlZIUk1CCkFmOEVDREFPQmdOVkhSTUJBZjhFQ0RBT0JnTlZIUThCQWY4RUJBTUNCNEF3Z2dJaU1BMEdDU3FHU0liM0RRRUIKQlFJZ0ZCUUlEQU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FnRUF2TmtaUnRLaXZrYTNXY0IvMFRMSmU2RXhnbjY3VApkUUhLU0d5bkU0UXdJaVRpdVFTS1daSDBKcW91aXQzSHZ4cnl0anQzS1E0b0M5Y0duRUJIQmxSSDRIZDNRUmIwCjVjU1MwYXR2WjJvUU9FV3VwZVd2VEFIdlZzVW9vR2RlcXl0OVNvVmtBM1hJWGZONXQvdkh6NGIzOEVqSldZK1UKb1lNVVdlSlZiUlFCNmE2a1hzZlJTSjBTK2dLMWNjcnVDbzJzUE9KQ1RtYkNmd25vUT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"    
  }

  mock_outputs_allowed_terraform_commands = ["plan", "refresh"]
  mock_outputs_merge_strategy_with_state = "shallow"
}

dependency "dev_cluster" {
 config_path = "../../dev/cluster"
 mock_outputs = {
    kube_host = "https://my-aks-cluster-12345678.hcp.uksouth.azmk8s.io:443"
    cluster_ca_certificate = "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURRakNDQWZnZ0F3SUJBZ0lVSWJvOXh1ekVXTzBBRWd5QjI0RUY4ZmFzSHdZd0RRWUpLb1pJaHZjTkFRRUwKQlFBd2N6RUxNQWtHQTFVRUJoTUNWVk14RHpBTkJna3Foa2lHOXcwQkNRRVdLQ1VnQ1FZRFZRUUdFd0pWVXpFRApNQWtHQTFVRUF3d0hhR1Z5WlhKaGRHOXlNQjRYRFRFNU1ETXdPREUxTXpJd05Gb1hEVEk1TURNeU5ERTFNekl3Ck5Gb3dVekVMTUFrR0ExVUVDaE1DVlZNeER6QU5CZ2txaGtpRzl3MEJDUUVXQmdVd0lGQWRCZ05WSFE0RUZnUVUKSm5BTm5oM1ZDUERvU3p5bDBFdzFkTkptWGkrV0F3SHdZRFZSMGpCQmd3Rm9BVUpuQU5uaDNWQ1BEb1N6eWwwRQp3MWROTm1YaStXQXdId1lEVlIwakJCZ3dGb0FVSm5BTm5oM1ZDUERvU3p5bDBFdzFkTkptWGkrV0F3SkJnWUEwCkJBUURBZ05JQURCRkFpQWZCZ05WSFNNRUdEQVdnQlVjbDBlWkRuNlFVa3hnSlRkM0Frd0NnWUlLb1pJemowRUEKQkFBT0JRS0FNSGlMZVFsMXFFcGpMRVBkQlAxZDNqYUpBaTRJSmpZUG5jU3JYbXRaQkNPM3V0R1B2aFB3K0dRQQp0czF3QjFTVkhSaXdiN3BNNEZWMFFqMUh3QXZnZGZ2N2ZHVlhZMHlDRnByVTFmUExRT2NoRXcvNWxyZXNQUUVECkFBd0NnWUlLb1pJemowRUF3SURTQUF3UlFJaEFtNFVZMGxyZmFiY0lvZytCWjM4amV6blZTRUVZb1dPUVhTdGgKYU1NZ01Dd0dBMVVkSlFRTU1Bb0dDQ3NHQVFVRkJ3TUJNR1V4R1RBWEJnTlZCQW9UQURCRU1Rc3dDUVlEVlFRRwpCUUJBUVVGQkFNTUNnWUlLb1pJemowRUF3SURTQUF3UlFJZ01ERUxNQWtHQTFVRUJ4TU1TV2x2YkdSbGNtbGgKWTJGc0xYTnZibXh2Y0d4bExtTnZiUzh4RURBT0JnTlZIUThCQWY4RUJBTUNCNEF3Z2dJaU1BMEdDU3FHU0liMwpDQ0FHUUFJaEFtNFVZMGxyZmFiY0lvZytCWjM4amV6blZTRUVZb1dPUVhTdGhhTU1nTTNFakFBTUJnTlZIUk1CCkFmOEVDREFPQmdOVkhSTUJBZjhFQ0RBT0JnTlZIUThCQWY4RUJBTUNCNEF3Z2dJaU1BMEdDU3FHU0liM0RRRUIKQlFJZ0ZCUUlEQU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FnRUF2TmtaUnRLaXZrYTNXY0IvMFRMSmU2RXhnbjY3VApkUUhLU0d5bkU0UXdJaVRpdVFTS1daSDBKcW91aXQzSHZ4cnl0anQzS1E0b0M5Y0duRUJIQmxSSDRIZDNRUmIwCjVjU1MwYXR2WjJvUU9FV3VwZVd2VEFIdlZzVW9vR2RlcXl0OVNvVmtBM1hJWGZONXQvdkh6NGIzOEVqSldZK1UKb1lNVVdlSlZiUlFCNmE2a1hzZlJTSjBTK2dLMWNjcnVDbzJzUE9KQ1RtYkNmd25vUT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"    
  }

  mock_outputs_allowed_terraform_commands = ["plan", "refresh"]
  mock_outputs_merge_strategy_with_state =  "shallow"
}

dependency "mgmt_cluster" {
 config_path = "../cluster"
 mock_outputs = {
    kube_host = "https://my-aks-cluster-12345678.hcp.uksouth.azmk8s.io:443"
    cluster_ca_certificate = "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURRakNDQWZnZ0F3SUJBZ0lVSWJvOXh1ekVXTzBBRWd5QjI0RUY4ZmFzSHdZd0RRWUpLb1pJaHZjTkFRRUwKQlFBd2N6RUxNQWtHQTFVRUJoTUNWVk14RHpBTkJna3Foa2lHOXcwQkNRRVdLQ1VnQ1FZRFZRUUdFd0pWVXpFRApNQWtHQTFVRUF3d0hhR1Z5WlhKaGRHOXlNQjRYRFRFNU1ETXdPREUxTXpJd05Gb1hEVEk1TURNeU5ERTFNekl3Ck5Gb3dVekVMTUFrR0ExVUVDaE1DVlZNeER6QU5CZ2txaGtpRzl3MEJDUUVXQmdVd0lGQWRCZ05WSFE0RUZnUVUKSm5BTm5oM1ZDUERvU3p5bDBFdzFkTkptWGkrV0F3SHdZRFZSMGpCQmd3Rm9BVUpuQU5uaDNWQ1BEb1N6eWwwRQp3MWROTm1YaStXQXdId1lEVlIwakJCZ3dGb0FVSm5BTm5oM1ZDUERvU3p5bDBFdzFkTkptWGkrV0F3SkJnWUEwCkJBUURBZ05JQURCRkFpQWZCZ05WSFNNRUdEQVdnQlVjbDBlWkRuNlFVa3hnSlRkM0Frd0NnWUlLb1pJemowRUEKQkFBT0JRS0FNSGlMZVFsMXFFcGpMRVBkQlAxZDNqYUpBaTRJSmpZUG5jU3JYbXRaQkNPM3V0R1B2aFB3K0dRQQp0czF3QjFTVkhSaXdiN3BNNEZWMFFqMUh3QXZnZGZ2N2ZHVlhZMHlDRnByVTFmUExRT2NoRXcvNWxyZXNQUUVECkFBd0NnWUlLb1pJemowRUF3SURTQUF3UlFJaEFtNFVZMGxyZmFiY0lvZytCWjM4amV6blZTRUVZb1dPUVhTdGgKYU1NZ01Dd0dBMVVkSlFRTU1Bb0dDQ3NHQVFVRkJ3TUJNR1V4R1RBWEJnTlZCQW9UQURCRU1Rc3dDUVlEVlFRRwpCUUJBUVVGQkFNTUNnWUlLb1pJemowRUF3SURTQUF3UlFJZ01ERUxNQWtHQTFVRUJ4TU1TV2x2YkdSbGNtbGgKWTJGc0xYTnZibXh2Y0d4bExtTnZiUzh4RURBT0JnTlZIUThCQWY4RUJBTUNCNEF3Z2dJaU1BMEdDU3FHU0liMwpDQ0FHUUFJaEFtNFVZMGxyZmFiY0lvZytCWjM4amV6blZTRUVZb1dPUVhTdGhhTU1nTTNFakFBTUJnTlZIUk1CCkFmOEVDREFPQmdOVkhSTUJBZjhFQ0RBT0JnTlZIUThCQWY4RUJBTUNCNEF3Z2dJaU1BMEdDU3FHU0liM0RRRUIKQlFJZ0ZCUUlEQU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FnRUF2TmtaUnRLaXZrYTNXY0IvMFRMSmU2RXhnbjY3VApkUUhLU0d5bkU0UXdJaVRpdVFTS1daSDBKcW91aXQzSHZ4cnl0anQzS1E0b0M5Y0duRUJIQmxSSDRIZDNRUmIwCjVjU1MwYXR2WjJvUU9FV3VwZVd2VEFIdlZzVW9vR2RlcXl0OVNvVmtBM1hJWGZONXQvdkh6NGIzOEVqSldZK1UKb1lNVVdlSlZiUlFCNmE2a1hzZlJTSjBTK2dLMWNjcnVDbzJzUE9KQ1RtYkNmd25vUT09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K"    
  }

  mock_outputs_allowed_terraform_commands = ["plan", "refresh"]
  mock_outputs_merge_strategy_with_state =  "shallow"
}

inputs = {
  mgmt_kube_host = dependency.mgmt_cluster.outputs.kube_host
  mgmt_cluster_ca_certificate = dependency.mgmt_cluster.outputs.cluster_ca_certificate
  
  dev_kube_host = dependency.dev_cluster.outputs.kube_host
  dev_cluster_ca_certificate = dependency.dev_cluster.outputs.cluster_ca_certificate

  stg_kube_host = dependency.stg_cluster.outputs.kube_host
  stg_cluster_ca_certificate = dependency.stg_cluster.outputs.cluster_ca_certificate

  argocd_admin_password = include.root.locals.argocd_admin_password
  azure_k8tre_mgmt_cluster_subscription_id = include.root.locals.azure_k8tre_mgmt_cluster_subscription_id
  azure_k8tre_dev_cluster_subscription_id = include.root.locals.azure_k8tre_dev_cluster_subscription_id
  azure_k8tre_stg_cluster_subscription_id = include.root.locals.azure_k8tre_stg_cluster_subscription_id


  spn_client_id = include.root.locals.spn_client_id
  azure_tenant_id = include.root.locals.azure_tenant_id


}